(function(){var g,n,b,o,h,k,p,a,e,m,d,c,s,t,i,q,l=Array.prototype.slice,j=Object.prototype.hasOwnProperty,f=function(u,v){return function(){return u.apply(v,arguments)}},r=function(x,v){for(var u in v){if(j.call(v,u)){x[u]=v[u]}}function w(){this.constructor=x}w.prototype=v.prototype;x.prototype=new w;x.__super__=v.prototype;return x};p=null;if(typeof Gettext!=="undefined"&&Gettext!==null){m=new Gettext({domain:"annotator"});p=function(u){return m.gettext(u)}}else{p=function(u){return u}}q=function(u){return p(u)};if(!(typeof jQuery!=="undefined"&&jQuery!==null?(i=jQuery.fn)!=null?i.jquery:void 0:void 0)){console.error(q("Annotator requires jQuery: have you included lib/vendor/jquery.js?"))}if(!(JSON&&JSON.parse&&JSON.stringify)){console.error(q("Annotator requires a JSON implementation: have you included lib/vendor/json2.js?"))}g=jQuery.sub();g.flatten=function(v){var u;u=function(x){var y,A,z,w;A=[];for(z=0,w=x.length;z<w;z++){y=x[z];A=A.concat(y&&g.isArray(y)?u(y):y)}return A};return u(v)};g.plugin=function(v,u){return jQuery.fn[v]=function(x){var w;w=Array.prototype.slice.call(arguments,1);return this.each(function(){var y;y=g.data(this,v);if(y){return x&&y[x].apply(y,w)}else{y=new u(this,x);return g.data(this,v,y)}})}};g.fn.textNodes=function(){var u;u=function(w){var v;if(w&&w.nodeType!==3){v=[];if(w.nodeType!==8){w=w.lastChild;while(w){v.push(u(w));w=w.previousSibling}}return v.reverse()}else{return w}};return this.map(function(){return g.flatten(u(this))})};g.fn.xpath=function(u){var v;v=this.map(function(){var x,w,y;y="";x=this;while(x&&x.nodeType===1&&x!==u){w=g(x.parentNode).children(x.tagName).index(x)+1;w=w>1?"["+w+"]":"";y="/"+x.tagName.toLowerCase()+w+y;x=x.parentNode}return y});return v.get()};g.escape=function(u){return u.replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};g.fn.escape=function(u){if(arguments.length){return this.html(g.escape(u))}return this.html()};k=["log","debug","info","warn","exception","assert","dir","dirxml","trace","group","groupEnd","groupCollapsed","time","timeEnd","profile","profileEnd","count","clear","table","error","notifyFirebug","firebug","userObjects"];if(typeof console!=="undefined"&&console!==null){if(!(console.group!=null)){console.group=function(u){return console.log("GROUP: ",u)}}if(!(console.groupCollapsed!=null)){console.groupCollapsed=console.group}for(d=0,s=k.length;d<s;d++){h=k[d];if(!(console[h]!=null)){console[h]=function(){return console.log(q("Not implemented:")+(" console."+name))}}}}else{this.console={};for(c=0,t=k.length;c<t;c++){h=k[c];this.console[h]=function(){}}this.console.error=function(){var u;u=1<=arguments.length?l.call(arguments,0):[];return alert("ERROR: "+(u.join(", ")))};this.console.warn=function(){var u;u=1<=arguments.length?l.call(arguments,0):[];return alert("WARNING: "+(u.join(", ")))}}b=(function(){u.prototype.events={};u.prototype.options={};u.prototype.element=null;function u(w,v){this.options=g.extend(true,{},this.options,v);this.element=g(w);this.on=this.subscribe;this.addEvents()}u.prototype.addEvents=function(){var y,A,z,v,x,C,B,w;C=this.events;w=[];for(z in C){A=C[z];B=z.split(" "),v=2<=B.length?l.call(B,0,x=B.length-1):(x=0,[]),y=B[x++];w.push(this.addEvent(v.join(" "),y,A))}return w};u.prototype.addEvent=function(v,x,y){var A,w,z=this;A=function(){return z[y].apply(z,arguments)};w=typeof v==="string"&&v.replace(/\s+/g,"")==="";if(w){v=this.element}if(typeof v==="string"){this.element.delegate(v,x,A)}else{if(this.isCustomEvent(x)){this.subscribe(x,A)}else{g(v).bind(x,A)}}return this};u.prototype.isCustomEvent=function(v){v=v.split(".")[0];return g.inArray(v,u.natives)===-1};u.prototype.publish=function(){this.element.triggerHandler.apply(this.element,arguments);return this};u.prototype.subscribe=function(v,x){var w;w=function(){return x.apply(this,[].slice.call(arguments,1))};w.guid=x.guid=(g.guid+=1);this.element.bind(v,w);return this};u.prototype.unsubscribe=function(){this.element.unbind.apply(this.element,arguments);return this};return u})();b.natives=(function(){var v,u,w;u=(function(){var y,x;y=jQuery.event.special;x=[];for(v in y){if(!j.call(y,v)){continue}w=y[v];x.push(v)}return x})();return"blur focus focusin focusout load resize scroll unload click dblclick\nmousedown mouseup mousemove mouseover mouseout mouseenter mouseleave\nchange select submit keydown keypress keyup error".split(/[^a-z]+/).concat(u)})();o={};o.sniff=function(u){if(u.commonAncestorContainer!=null){return new o.BrowserRange(u)}else{if(typeof u.start==="string"){return new o.SerializedRange(u)}else{if(u.start&&typeof u.start==="object"){return new o.NormalizedRange(u)}else{console.error(q("Could not sniff range type"));return false}}}};o.BrowserRange=(function(){function u(v){this.commonAncestorContainer=v.commonAncestorContainer;this.startContainer=v.startContainer;this.startOffset=v.startOffset;this.endContainer=v.endContainer;this.endOffset=v.endOffset}u.prototype.normalize=function(D){var C,y,E,B,x,w,A,v,z;if(this.tainted){console.error(q("You may only call normalize() once on a BrowserRange!"));return false}else{this.tainted=true}w={};E={};z=["start","end"];for(A=0,v=z.length;A<v;A++){x=z[A];y=this[x+"Container"];B=this[x+"Offset"];if(y.nodeType===1){C=y.childNodes[B];y=C||y.childNodes[B-1];while(y.nodeType!==3){y=y.firstChild}B=C?0:y.nodeValue.length}w[x]=y;w[x+"Offset"]=B}E.start=w.startOffset>0?w.start.splitText(w.startOffset):w.start;if(w.start===w.end){if((w.endOffset-w.startOffset)<E.start.nodeValue.length){E.start.splitText(w.endOffset-w.startOffset)}E.end=E.start}else{if(w.endOffset<w.end.nodeValue.length){w.end.splitText(w.endOffset)}E.end=w.end}E.commonAncestor=this.commonAncestorContainer;while(E.commonAncestor.nodeType!==1){E.commonAncestor=E.commonAncestor.parentNode}return new o.NormalizedRange(E)};u.prototype.serialize=function(v,w){return this.normalize(v).serialize(v,w)};return u})();o.NormalizedRange=(function(){function u(v){this.commonAncestor=v.commonAncestor;this.start=v.start;this.end=v.end}u.prototype.normalize=function(v){return this};u.prototype.limit=function(z){var v,y,w,x,B,A;v=g.grep(this.textNodes(),function(C){return C.parentNode===z||g.contains(z,C.parentNode)});if(!v.length){return null}this.start=v[0];this.end=v[v.length-1];w=g(this.start).parents();A=g(this.end).parents();for(x=0,B=A.length;x<B;x++){y=A[x];if(w.index(y)!==-1){this.commonAncestor=y;break}}return this};u.prototype.serialize=function(x,y){var w,v,z;v=function(E,D){var C,B,G,J,I,H,F,A;if(y){J=g(E).parents(":not("+y+")").eq(0)}else{J=g(E).parent()}H=J.xpath(x)[0];I=J.textNodes();B=I.slice(0,I.index(E));G=0;for(F=0,A=B.length;F<A;F++){C=B[F];G+=C.nodeValue.length}if(D){return[H,G+E.nodeValue.length]}else{return[H,G]}};z=v(this.start);w=v(this.end,true);return new o.SerializedRange({start:z[0],end:w[0],startOffset:z[1],endOffset:w[1]})};u.prototype.text=function(){var v;return((function(){var x,z,y,w;y=this.textNodes();w=[];for(x=0,z=y.length;x<z;x++){v=y[x];w.push(v.nodeValue)}return w}).call(this)).join("")};u.prototype.textNodes=function(){var v,y,w,x;w=g(this.commonAncestor).textNodes();x=[w.index(this.start),w.index(this.end)],y=x[0],v=x[1];return g.makeArray(w.slice(y,v+1||9000000000))};u.prototype.toRange=function(){var v;v=document.createRange();v.setStartBefore(this.start);v.setEndAfter(this.end);return v};return u})();o.SerializedRange=(function(){function u(v){this.start=v.start;this.startOffset=v.startOffset;this.end=v.end;this.endOffset=v.endOffset}u.prototype._nodeFromXPath=function(v){var A,z,w,y,x;z=function(C,B){if(B==null){B=null}return document.evaluate(C,document,B,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue};if(!g.isXMLDoc(document.documentElement)){return z(v)}else{A=document.createNSResolver(document.ownerDocument===null?document.documentElement:document.ownerDocument.documentElement);y=z(v,A);if(!y){v=((function(){var C,E,D,B;D=v.split("/");B=[];for(C=0,E=D.length;C<E;C++){x=D[C];if(x&&x.indexOf(":")===-1){B.push(x.replace(/^([a-z]+)/,"xhtml:$1"))}else{B.push(x)}}return B})()).join("/");w=document.lookupNamespaceURI(null);A=function(B){if(B==="xhtml"){return w}else{return document.documentElement.getAttribute("xmlns:"+B)}};y=z(v,A)}return y}};u.prototype.normalize=function(H){var L,E,D,J,B,G,I,F,C,A,w,v,M,K,z,y,x;I=g(H).xpath()[0];C=this.start.split("/");D=this.end.split("/");E=[];F={};for(J=0,z=C.length;0<=z?J<z:J>z;0<=z?J++:J--){if(C[J]===D[J]){E.push(C[J])}else{break}}L=I+E.join("/");F.commonAncestorContainer=this._nodeFromXPath(L);if(!F.commonAncestorContainer){console.error(q("Error deserializing range: can't find XPath '")+L+q("'. Is this the right document?"));return null}y=["start","end"];for(w=0,M=y.length;w<M;w++){G=y[w];B=0;x=g(this._nodeFromXPath(I+this[G])).textNodes();for(v=0,K=x.length;v<K;v++){A=x[v];if(B+A.nodeValue.length>=this[G+"Offset"]){F[G+"Container"]=A;F[G+"Offset"]=this[G+"Offset"]-B;break}else{B+=A.nodeValue.length}}}return new o.BrowserRange(F).normalize(H)};u.prototype.serialize=function(v,w){return this.normalize(v).serialize(v,w)};u.prototype.toObject=function(){return{start:this.start,startOffset:this.startOffset,end:this.end,endOffset:this.endOffset}};return u})();a={uuid:(function(){var u;u=0;return function(){return u++}})(),getGlobal:function(){return(function(){return this})()},mousePosition:function(u,w){var v;v=g(w).offset();return{top:u.pageY-v.top,left:u.pageX-v.left}},preventEventDefault:function(u){return u!=null?typeof u.preventDefault==="function"?u.preventDefault():void 0:void 0}};e=this.Annotator;n=(function(u){r(v,u);v.prototype.events={".annotator-adder button click":"onAdderClick",".annotator-adder button mousedown":"onAdderMousedown",".annotator-hl mouseover":"onHighlightMouseover",".annotator-hl mouseout":"startViewerHideTimer"};v.prototype.html={hl:'<span class="annotator-hl"></span>',adder:'<div class="annotator-adder"><button>'+q("Annotate")+"</button></div>",wrapper:'<div class="annotator-wrapper"></div>'};v.prototype.options={};v.prototype.plugins={};v.prototype.editor=null;v.prototype.viewer=null;v.prototype.selectedRanges=null;v.prototype.mouseIsDown=false;v.prototype.ignoreMouseup=false;v.prototype.viewerHideTimer=null;function v(y,x){this.onDeleteAnnotation=f(this.onDeleteAnnotation,this);this.onEditAnnotation=f(this.onEditAnnotation,this);this.onAdderClick=f(this.onAdderClick,this);this.onAdderMousedown=f(this.onAdderMousedown,this);this.onHighlightMouseover=f(this.onHighlightMouseover,this);this.checkForEndSelection=f(this.checkForEndSelection,this);this.checkForStartSelection=f(this.checkForStartSelection,this);this.clearViewerHideTimer=f(this.clearViewerHideTimer,this);this.startViewerHideTimer=f(this.startViewerHideTimer,this);this.showViewer=f(this.showViewer,this);this.onEditorSubmit=f(this.onEditorSubmit,this);this.onEditorHide=f(this.onEditorHide,this);this.showEditor=f(this.showEditor,this);var w,z,A;v.__super__.constructor.apply(this,arguments);this.plugins={};if(!v.supported()){return this}this._setupDocumentEvents()._setupWrapper()._setupViewer()._setupEditor();A=this.html;for(w in A){z=A[w];if(w!=="wrapper"){this[w]=g(z).appendTo(this.wrapper).hide()}}}v.prototype._setupWrapper=function(){this.wrapper=g(this.html.wrapper);this.element.find("script").remove();this.element.wrapInner(this.wrapper);this.wrapper=this.element.find(".annotator-wrapper");return this};v.prototype._setupViewer=function(){var w=this;this.viewer=new v.Viewer();this.viewer.hide().on("edit",this.onEditAnnotation).on("delete",this.onDeleteAnnotation).addField({load:function(y,x){if(x.text){g(y).escape(x.text)}else{g(y).html("<i>"+(q("No Comment"))+"</i>")}return w.publish("annotationViewerTextField",[y,x])}}).element.appendTo(this.wrapper).bind({mouseover:this.clearViewerHideTimer,mouseout:this.startViewerHideTimer});return this};v.prototype._setupEditor=function(){this.editor=new v.Editor();this.editor.hide().on("hide",this.onEditorHide).on("save",this.onEditorSubmit).addField({type:"textarea",label:q("Comments")+"\u2026",load:function(x,w){return g(x).find("textarea").val(w.text||"")},submit:function(x,w){return w.text=g(x).find("textarea").val()}});this.editor.element.appendTo(this.wrapper);return this};v.prototype._setupDocumentEvents=function(){g(document).bind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection});return this};v.prototype.getSelectedRanges=function(){var z,x,w,y;y=a.getGlobal().getSelection();w=[];if(!y.isCollapsed){w=(function(){var B,A;A=[];for(x=0,B=y.rangeCount;0<=B?x<B:x>B;0<=B?x++:x--){z=new o.BrowserRange(y.getRangeAt(x));A.push(z.normalize().limit(this.wrapper[0]))}return A}).call(this);y.removeAllRanges()}return g.grep(w,function(A){if(A){y.addRange(A.toRange())}return A})};v.prototype.createAnnotation=function(){var w;w={};this.publish("beforeAnnotationCreated",[w]);return w};v.prototype.setupAnnotation=function(w,y){var x,C,B,z,A,D;if(y==null){y=true}w.ranges||(w.ranges=this.selectedRanges);C=(function(){var F,H,G,E;G=w.ranges;E=[];for(F=0,H=G.length;F<H;F++){B=G[F];z=o.sniff(B);E.push(z.normalize(this.wrapper[0]))}return E}).call(this);C=g.grep(C,function(E){return E!==null});w.quote=[];w.ranges=[];w.highlights=[];for(A=0,D=C.length;A<D;A++){x=C[A];w.quote.push(g.trim(x.text()));w.ranges.push(x.serialize(this.wrapper[0],".annotator-hl"));g.merge(w.highlights,this.highlightRange(x))}w.quote=w.quote.join(" / ");g(w.highlights).data("annotation",w);if(y){this.publish("annotationCreated",[w])}return w};v.prototype.updateAnnotation=function(w){this.publish("beforeAnnotationUpdated",[w]);this.publish("annotationUpdated",[w]);return w};v.prototype.deleteAnnotation=function(w){var y,x,A,z;z=w.highlights;for(x=0,A=z.length;x<A;x++){y=z[x];g(y).replaceWith(y.childNodes)}this.publish("annotationDeleted",[w]);return w};v.prototype.loadAnnotations=function(x){var z,w,y=this;if(x==null){x=[]}w=function(C){var E,A,B,D;if(C==null){C=[]}A=C.splice(0,10);for(B=0,D=A.length;B<D;B++){E=A[B];y.setupAnnotation(E,false)}if(C.length>0){return setTimeout((function(){return w(C)}),100)}else{return y.publish("annotationsLoaded",[z])}};z=x.slice();if(x.length){w(x)}return this};v.prototype.dumpAnnotations=function(){if(this.plugins.Store){return this.plugins.Store.dumpAnnotations()}else{return console.warn(q("Can't dump annotations without Store plugin."))}};v.prototype.highlightRange=function(z){var A,x,y,C,B,w;x=/^\s*$/;B=z.textNodes();w=[];for(y=0,C=B.length;y<C;y++){A=B[y];if(!x.test(A.nodeValue)){w.push(g(A).wrapAll(this.hl).parent().show()[0])}}return w};v.prototype.addPlugin=function(y,x){var w,z;if(this.plugins[y]){console.error(q("You cannot have more than one instance of any plugin."))}else{w=v.Plugin[y];if(typeof w==="function"){this.plugins[y]=new w(this.element[0],x);this.plugins[y].annotator=this;if(typeof(z=this.plugins[y]).pluginInit==="function"){z.pluginInit()}}else{console.error(q("Could not load ")+y+q(" plugin. Have you included the appropriate <script> tag?"))}}return this};v.prototype.showEditor=function(w,x){this.editor.element.css(x);this.editor.load(w);return this};v.prototype.onEditorHide=function(){this.publish("annotationEditorHidden",[this.editor]);return this.ignoreMouseup=false};v.prototype.onEditorSubmit=function(w){this.publish("annotationEditorSubmit",[this.editor,w]);if(w.ranges===void 0){return this.setupAnnotation(w)}else{return this.updateAnnotation(w)}};v.prototype.showViewer=function(x,w){this.viewer.element.css(w);this.viewer.load(x);return this.publish("annotationViewerShown",[this.viewer,x])};v.prototype.startViewerHideTimer=function(){if(!this.viewerHideTimer){return this.viewerHideTimer=setTimeout(this.viewer.hide,250)}};v.prototype.clearViewerHideTimer=function(){clearTimeout(this.viewerHideTimer);return this.viewerHideTimer=false};v.prototype.checkForStartSelection=function(w){if(!(w&&this.isAnnotator(w.target))){this.startViewerHideTimer();return this.mouseIsDown=true}};v.prototype.checkForEndSelection=function(z){var w,x,y,B,A;this.mouseIsDown=false;if(this.ignoreMouseup){return}this.selectedRanges=this.getSelectedRanges();A=this.selectedRanges;for(y=0,B=A.length;y<B;y++){x=A[y];w=x.commonAncestor;if(this.isAnnotator(w)){return}}if(z&&this.selectedRanges.length){return this.adder.css(a.mousePosition(z,this.wrapper[0])).show()}else{return this.adder.hide()}};v.prototype.isAnnotator=function(w){return !!g(w).parents().andSelf().filter("[class^=annotator-]").not(this.wrapper).length};v.prototype.onHighlightMouseover=function(w){var x;this.clearViewerHideTimer();if(this.mouseIsDown||this.viewer.isShown()){return false}x=g(w.target).parents(".annotator-hl").andSelf().map(function(){return g(this).data("annotation")});return this.showViewer(g.makeArray(x),a.mousePosition(w,this.wrapper[0]))};v.prototype.onAdderMousedown=function(w){if(w!=null){w.preventDefault()}return this.ignoreMouseup=true};v.prototype.onAdderClick=function(x){var w;if(x!=null){x.preventDefault()}w=this.adder.position();this.adder.hide();return this.showEditor(this.createAnnotation(),w)};v.prototype.onEditAnnotation=function(w){var x;x=this.viewer.element.position();this.viewer.hide();return this.showEditor(w,x)};v.prototype.onDeleteAnnotation=function(w){this.viewer.hide();return this.deleteAnnotation(w)};return v})(b);n.Plugin=(function(v){r(u,v);function u(x,w){u.__super__.constructor.apply(this,arguments)}u.prototype.pluginInit=function(){};return u})(b);n.$=g;n.Delegator=b;n.Range=o;n._t=q;n.supported=function(){return(function(){return !!this.getSelection})()};n.noConflict=function(){a.getGlobal().Annotator=e;return this};g.plugin("annotator",n);this.Annotator=n;n.Widget=(function(v){r(u,v);u.prototype.classes={hide:"annotator-hide",invert:{x:"annotator-invert-x",y:"annotator-invert-y"}};function u(x,w){u.__super__.constructor.apply(this,arguments);this.classes=g.extend({},n.Widget.prototype.classes,this.classes)}u.prototype.checkOrientation=function(){var z,A,w,y,x;this.resetOrientation();x=g(a.getGlobal());y=this.element.children(":first");A=y.offset();w={top:x.scrollTop(),right:x.width()+x.scrollLeft()};z={top:A.top,right:A.left+y.width()};if((z.top-w.top)<0){this.invertY()}if((z.right-w.right)>0){this.invertX()}return this};u.prototype.resetOrientation=function(){this.element.removeClass(this.classes.invert.x).removeClass(this.classes.invert.y);return this};u.prototype.invertX=function(){this.element.addClass(this.classes.invert.x);return this};u.prototype.invertY=function(){this.element.addClass(this.classes.invert.y);return this};u.prototype.isInvertedY=function(){return this.element.hasClass(this.classes.invert.y)};u.prototype.isInvertedX=function(){return this.element.hasClass(this.classes.invert.x)};return u})(b);n.Editor=(function(v){r(u,v);u.prototype.events={"form submit":"submit",".annotator-save click":"submit",".annotator-cancel click":"hide",".annotator-cancel mouseover":"onCancelButtonMouseover","textarea keydown":"processKeypress"};u.prototype.classes={hide:"annotator-hide",focus:"annotator-focus"};u.prototype.html='<div class="annotator-outer annotator-editor">\n  <form class="annotator-widget">\n    <ul class="annotator-listing"></ul>\n    <div class="annotator-controls">\n      <a href="#cancel" class="annotator-cancel">'+q("Cancel")+'</a>\n<a href="#save" class="annotator-save annotator-focus">'+q("Save")+'</a>\n    </div>\n    <span class="annotator-resize"></span>\n  </form>\n</div>';u.prototype.options={};function u(w){this.onCancelButtonMouseover=f(this.onCancelButtonMouseover,this);this.processKeypress=f(this.processKeypress,this);this.submit=f(this.submit,this);this.load=f(this.load,this);this.hide=f(this.hide,this);this.show=f(this.show,this);u.__super__.constructor.call(this,g(this.html)[0],w);this.fields=[];this.annotation={};this.setupDraggables()}u.prototype.show=function(x){var w;a.preventEventDefault(x);this.element.removeClass(this.classes.hide);this.element.find(".annotator-save").addClass(this.classes.focus);this.checkOrientation();w=this.isInvertedY()?":last":":first";this.element.find(":input"+w).focus();return this.publish("show")};u.prototype.hide=function(w){a.preventEventDefault(w);this.element.addClass(this.classes.hide);return this.publish("hide")};u.prototype.load=function(w){var y,x,A,z;this.annotation=w;this.publish("load",[this.annotation]);z=this.fields;for(x=0,A=z.length;x<A;x++){y=z[x];y.load(y.element,this.annotation)}return this.show()};u.prototype.submit=function(x){var y,w,A,z;a.preventEventDefault(x);z=this.fields;for(w=0,A=z.length;w<A;w++){y=z[w];y.submit(y.element,this.annotation)}this.publish("save",[this.annotation]);return this.hide()};u.prototype.addField=function(x){var y,z,w;z=g.extend({id:"annotator-field-"+a.uuid(),type:"input",label:"",load:function(){},submit:function(){}},x);w=null;y=g('<li class="annotator-item" />');z.element=y[0];switch(z.type){case"textarea":w=g("<textarea />");break;case"input":case"checkbox":w=g("<input />")}y.append(w);w.attr({id:z.id,placeholder:z.label});if(z.type==="checkbox"){w[0].type="checkbox";y.addClass("annotator-checkbox");y.append(g("<label />",{"for":z.id,html:z.label}))}this.element.find("ul:first").append(y);this.fields.push(z);return z.element};u.prototype.checkOrientation=function(){var w,y,x;u.__super__.checkOrientation.apply(this,arguments);x=this.element.find("ul");w=this.element.find(".annotator-controls");y=function(){return x.children().each(function(){return g(this).parent().prepend(this)})};if(this.element.hasClass(this.classes.invert.y)&&x.is(":first-child")){w.insertBefore(x);y()}else{if(w.is(":first-child")){w.insertAfter(x);y()}}return this};u.prototype.processKeypress=function(w){if(w.keyCode===27){return this.hide()}else{if(w.keyCode===13&&!w.shiftKey){return this.submit()}}};u.prototype.onCancelButtonMouseover=function(){return this.element.find("."+this.classes.focus).removeClass(this.classes.focus)};u.prototype.setupDraggables=function(){var y,G,C,w,A,E,z,x,D,F,B=this;w=null;y=this.classes;C=this.element;D=null;x=C.find(".annotator-resize");G=C.find(".annotator-controls");F=false;A=function(H){if(H.target===this){w={element:this,top:H.pageY,left:H.pageX};D=C.find("textarea:first");g(window).bind({"mouseup.annotator-editor-resize":z,"mousemove.annotator-editor-resize":E});return H.preventDefault()}};z=function(){w=null;return g(window).unbind(".annotator-editor-resize")};E=function(L){var M,J,I,H,K;if(w&&F===false){M={top:L.pageY-w.top,left:L.pageX-w.left};if(w.element===x[0]){H=D.outerHeight();K=D.outerWidth();J=C.hasClass(y.invert.x)?-1:1;I=C.hasClass(y.invert.y)?1:-1;D.height(H+(M.top*I));D.width(K+(M.left*J));if(D.outerHeight()!==H){w.top=L.pageY}if(D.outerWidth()!==K){w.left=L.pageX}}else{if(w.element===G[0]){C.css({top:parseInt(C.css("top"),10)+M.top,left:parseInt(C.css("left"),10)+M.left});w.top=L.pageY;w.left=L.pageX}}F=true;return setTimeout(function(){return F=false},1000/60)}};x.bind("mousedown",A);return G.bind("mousedown",A)};return u})(n.Widget);n.Viewer=(function(u){r(v,u);v.prototype.events={".annotator-edit click":"onEditClick",".annotator-delete click":"onDeleteClick"};v.prototype.classes={hide:"annotator-hide",showControls:"annotator-visible"};v.prototype.html={element:'<div class="annotator-outer annotator-viewer">\n  <ul class="annotator-widget annotator-listing"></ul>\n</div>',item:'<li class="annotator-annotation annotator-item">\n  <span class="annotator-controls">\n    <button class="annotator-edit">Edit</button>\n    <button class="annotator-delete">Delete</button>\n  </span>\n</li>'};function v(w){this.onDeleteClick=f(this.onDeleteClick,this);this.onEditClick=f(this.onEditClick,this);this.load=f(this.load,this);this.hide=f(this.hide,this);this.show=f(this.show,this);v.__super__.constructor.call(this,g(this.html.element)[0],w);this.item=g(this.html.item)[0];this.fields=[];this.annotations=[]}v.prototype.show=function(x){var w,y=this;a.preventEventDefault(x);w=this.element.find(".annotator-controls").addClass(this.classes.showControls);setTimeout((function(){return w.removeClass(y.classes.showControls)}),500);this.element.removeClass(this.classes.hide);return this.checkOrientation().publish("show")};v.prototype.isShown=function(){return !this.element.hasClass(this.classes.hide)};v.prototype.hide=function(w){a.preventEventDefault(w);this.element.addClass(this.classes.hide);return this.publish("hide")};v.prototype.load=function(E){var B,D,I,J,H,C,G,K,F,A,y,w,L,z,x;this.annotations=E||[];F=this.element.find("ul:first").empty();z=this.annotations;for(A=0,w=z.length;A<w;A++){B=z[A];K=g(this.item).clone().appendTo(F).data("annotation",B);I=K.find(".annotator-controls");H=I.find(".annotator-edit");J=I.find(".annotator-delete");D={showEdit:function(){return H.removeAttr("disabled")},hideEdit:function(){return H.attr("disabled","disabled")},showDelete:function(){return J.removeAttr("disabled")},hideDelete:function(){return J.attr("disabled","disabled")}};x=this.fields;for(y=0,L=x.length;y<L;y++){G=x[y];C=g(G.element).clone().appendTo(K)[0];G.load(C,B,D)}}this.publish("load",[this.annotations]);return this.show()};v.prototype.addField=function(w){var x;x=g.extend({load:function(){}},w);x.element=g("<div />")[0];this.fields.push(x);x.element;return this};v.prototype.onEditClick=function(w){return this.onButtonClick(w,"edit")};v.prototype.onDeleteClick=function(w){return this.onButtonClick(w,"delete")};v.prototype.onButtonClick=function(y,w){var x;x=g(y.target).parents(".annotator-annotation");return this.publish(w,[x.data("annotation")])};return v})(n.Widget);n=n||{};n.Notification=(function(u){r(v,u);v.prototype.events={click:"hide"};v.prototype.options={html:"<div class='annotator-notice'></div>",classes:{show:"annotator-notice-show",info:"annotator-notice-info",success:"annotator-notice-success",error:"annotator-notice-error"}};function v(w){this.hide=f(this.hide,this);this.show=f(this.show,this);v.__super__.constructor.call(this,g(this.options.html).appendTo(document.body)[0],w)}v.prototype.show=function(x,w){if(w==null){w=n.Notification.INFO}g(this.element).addClass(this.options.classes.show).addClass(this.options.classes[w]).escape(x||"");setTimeout(this.hide,5000);return this};v.prototype.hide=function(){g(this.element).removeClass(this.options.classes.show);return this};return v})(b);n.Notification.INFO="show";n.Notification.SUCCESS="success";n.Notification.ERROR="error";g(function(){var u;u=new n.Notification;n.showNotification=u.show;return n.hideNotification=u.hide})}).call(this);